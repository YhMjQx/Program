# ==路由器的工作原理==

## 一、回顾交换机的工作原理

- 交换机里面维护了一张MAC地址表，主要是记录的MAC地址和对应接口之间的关系
- 交换机在初始状态下，MAC地址表示空的，当收到一个来自某个接口（假设为F0/1）的数据时，首先查看数据帧中的源MAC地址，对照自己的MAC地址表，如果表中没有相应的数据，就学习发送方的MAC地址并附加上对应的接口（这里是F0/1）。接着继续查看目的MAC地址，如果也不再自己的MAC地址表中就从除过接收接口外的所有接口进行广播发送，此时，除过源主机，其他的所有主机都可以接收到该数据帧，但是只有目的主机保留数据帧并做出回应，其他的所有主机都会丢弃该数据帧（因为这些主句发现目的MAC地址并不是自己的）。回应的过程也是交给交换机进行转发当交换机接收到回应报文后（假设是接口F0/2），查看ACK的源MAC地址，如果没有就学习这个MAC地址并附加上它与接口F0/2的关系，在哦查看那ACK的目的MAC地址，发现有记录于是就直接单播给新的目的主机
- 总结：交换机学习数据的源MAC地址，广播数据帧，接收方回应回应使用单播直接转发

## 二、回顾路由器的相关知识

- 路由器属于三层设备（网络层）设备

- 网络层所封装的IP头部

- 网络层功能

  - 进行逻辑地址（IP地址）寻址，实现不同网络（网络地址不等或内网与外网的分隔）之间的路径选择。**注意：内网的IP地址是无法在外网上进行路由的**

  - 去查找目的是否可以到达，如果可以到达，选择一条最优路径，如果不能到达，直接返回给发送方一个消息

- 网络层所传输的PDU（传输数据单元）是数据包（IP数据包）

## 三、网络层IP数据包的格式



![IPV4数据报头部格式](https://img-blog.csdn.net/20170511155357711?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMTc4NDQ5NQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)



- IPV4
  - 版本：标识当前使用的IP版本（IPV4，IPV6）
  - 首部长度：由于IP数据包问的首部有一个可选项，造成首部长度是可变的，所以需要定义
  - 区分服务（服务质量/优先级和服务类型）：为了保障更好的服务，主要是在IP层做Qos（服务质量）
  - 总长度：主要用来标识整个数据包的长度
  - 标识，标志，片位移：上层来的数据到网络层会被分片，这几个字段用来对数据包进行标识，使数据到达目的端重组的时候不会乱序
  - 生存时间（TTL）：表示数据包在网络中的寿命，功能是“跳数限制”，表明是数据报在网络中的寿命，单位为秒设置了数据包可以经过的最多路由器数量。
  - 协议：标识上层数据使用的何种协议（TCP是6或UDP是17）
  - 首部校验：校验数据报文的首部
  - 源地址：发送方的IP地址
  - 目的地址：接收方的IP地址
- IPV6

## 四、路由器的工作原理

### 1.路由

- 从源主机到目标主机的转发过程（跨网路访问）
- 包含两个内容：
  - 确定最佳路径（手动指定，使用动态路由协商方式）
  - 通过网络传输信息

### 2.路由器的工作原理

​	![image-20230718193748625](C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230718193748625.png)

- 路由表
  - 直连路由：当路由器的接口配置好对应的IP地址并开启接口后自动生成
  - 非直连路由：需要手动配置静态路由（手动配置）或者使用动态路由协议学习到

## 3.静态路由

- 由管理员手动配置，不灵活，而且是单向的
- 特殊的静态路由：默认路由（想去哪就去哪），当在路由器中找不到目标网络的路由条目时，再去查看默认路由
  - 使用场景：一般应用于末节（末梢）网络（网络的最末端）（路由器只连接了一个网络）（如上图所示，我可以在R1出口的位置配置默认路由）

## 4.动态路由

- 通过某种动态路由协议自动的去建立自己的路由表
- 常见的动态路由协议：RIP,OSPF,BGP,IGRP,EIGRP(这是Cisco的一个私有协议)

## 五、路由器在转发数据包的封装过程

网关：与自己直连的路由器的IP地址

![image-20230719150839037](C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230719150839037.png)

### 对PC1的配置

```swift
PC1#conf t
PC1(config)#int f0/0
PC1(config-if)#ip add 192.168.10.1 255.255.255.0   #接口模式配置接口的IP地址和子网掩码
PC1(config-if)#no shutdown         #将配置好的IP和子										网掩码应用
PC1(config-if)#exit
PC1(config)#no ip routing        #关掉PC的路由功能
PC1(config)#ip default-gateway 192.168.10.254   #设置网关
```

对PC2的配置和PC1的配置基本一样

### 对路由器的配置（全局模式下）

#### 1.指定发出接口名字

```swift
R1(config)#ip route 192.168.100.0 255.255.255.0 fastEthernet 1/0
```

上面这是给R1配置路由的一种方式，讲解：

- 192.168.100.0，这是目标网络的网段
- fastEthernet 1/0，这是R1的f1/0接口

#### 2.指定下一个路由器接口的IP地址

```swift
R1(config)#ip route 192.168.100.0 255.255.255.0 192.168.50.2
```

这种方式只是最后的地方发生了变化，解释如下：

- 192.168.100.0，这依旧是目标网络的网段
- 192.168.50.2，这是R2的f1/0接口的IP地址

配置好之后我们就可以尝试ping一下，出现 . 表示ping不通，出现 ！ 表示ping通 

![image-20230719141639109](C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230719141639109.png)

接下来查看一下每个接口的MAC地址（特权模式下哦）

```swift
hostname#show int f0/0
```

![image-20230719142030336](C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230719142030336.png)

MAC地址是：![image-20230719142209517](C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230719142209517.png)

现在开始抓包

![image-20230719143502760](C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230719143502760.png)

对所有线路右击，选择这个选项，自动打开wireshark，然后都打开了之后，让PC1ping（使用的是ICMP协议）通PC2，就可以抓取每条线路上的数据包了

PC1到PC1属于三层转发过程，但是每单独一条链路都是二层转发过程

**PC1访问PC2：**

第一个报文：源IP是PC1的IP，目的IP是PC2的IP；源MAC是PC1的MAC，目的MAC是R1 f0/0接口的MAC

当R1收到数据报文后，回解封装到网络层，查看目的地是否可到，如果可到就转发到相对应的接口，重新进行二层封装（此时就是修改源MAC和目的MAC），源MAC变成了R1 f1/0 接口MAC，目的MAC变成了R2 f1/0 接口MAC

当R2接收到数据报文后，回解封装到网络层，查看目的地是否可到，如果可到就将数据转发给相应的接口，然后重新进行二层封装，源MAC变为R2 f0/0 接口MAC，目的MAC变为PC2的MAC

**路由器在转发数据包的封装过程：**

源IP地址和目的IP地址永远保持不变

源MAC和目的MAC是一直在发生变化的（路由器会进行重新二层封装）

同网段传输主要是二层转发（不需要进行重新封装）

跨网段传输时三层转发（需要进行重新二层封装啦以改变MAC地址）

